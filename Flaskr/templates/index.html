<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="AL&DS Shop — premium, responsive product listing" />
  <title>AL&DS Shop — Home</title>

  <link rel="icon" sizes="16x16" href="../static/favicon/favicon-16x16.png">
  <link rel="icon" sizes="32x32" href="../static/favicon/favicon-32x32.png">

  <link rel="stylesheet" href="../static/style.css">
</head>
<body>

  {% include 'header.html' %}

  <section class="toolbar" aria-label="Search and sort products">
    <form id="search-form" role="search" onsubmit="return false;" aria-label="Search products">
      <label for="search-input" class="sr-only">Search products</label>
      <input id="search-input" class="input-control" type="search" placeholder="Search products…" aria-label="Search products" autocomplete="off" />
    </form>

    <div class="toolbar__field" aria-hidden="false">
      <label for="ordering-select" class="sr-only">Sort products by</label>
      <select id="ordering-select" class="select-control" aria-label="Sort products">
        <option value="" selected disabled hidden>Select Sorting system</option>
        <option value="category">Category</option>
        <option value="price_asc">Price: Low → High</option>
        <option value="price_desc">Price: High → Low</option>
        <option value="name_asc">Name: A → Z</option>
        <option value="name_desc">Name: Z → A</option>
      </select>
    </div>

    <div>
      <button id="btn-sort" class="btn-sort" aria-label="Apply sorting">Sort</button>
    </div>
  </section>

  <div aria-live="polite" aria-atomic="true" id="results-count" class="sr-only"></div>

  <main id="main-content" role="main">
    <section id="products-grid" class="product-grid" aria-label="Products">
      {% if sorting_system == "category" %}
        {% for key, value in products.items() %}
          <h2 class="product-grid__category-title">{{ key }}</h2>
          {% for product in value %}
            <a class="product-card js-product-item"
               href="/product?id={{ product.productid }}&supplierid={{ product.supplierid }}&categoryid={{ product.categoryid }}"
               data-id="{{ product.productid }}"
               data-supplier="{{ product.supplierid }}"
               data-category="{{ product.categoryid }}"
               data-name="{{ product.productname|default('') }}"
               data-price="{{ product.price|default(0) }}">
              <p class="product-card__title">{{ product.productname }}</p>
              <p class="product-card__meta">{{ product.unit }}</p>
              <p class="product-card__price">${{ '%.2f'|format(product.price) }}</p>
            </a>
          {% endfor %}
        {% endfor %}
      {% elif products %}
        {% for product in products %}
          <a class="product-card js-product-item"
             href="/product?id={{ product.productid }}&supplierid={{ product.supplierid }}&categoryid={{ product.categoryid }}"
             data-id="{{ product.productid }}"
             data-supplier="{{ product.supplierid }}"
             data-category="{{ product.categoryid }}"
             data-name="{{ product.productname|default('') }}"
             data-price="{{ product.price|default(0) }}">
            <p class="product-card__title">{{ product.productname }}</p>
            <p class="product-card__meta">{{ product.unit }}</p>
            <p class="product-card__price">${{ '%.2f'|format(product.price) }}</p>
          </a>
        {% endfor %}
      {% else %}
        <div class="empty-state">No products available.</div>
      {% endif %}
    </section>

    <div id="empty-state-js" class="empty-state" style="display:none">No products found.</div>
  </main>

  {% include 'modals.html' %}

  <script>
    (function () {
      'use strict';

      // --- DOM Elements ---
      const els = {
        searchInput: document.getElementById('search-input'),
        orderingSelect: document.getElementById('ordering-select'),
        sortButton: document.getElementById('btn-sort'),
        resultsCount: document.getElementById('results-count'),
        emptyStateJs: document.getElementById('empty-state-js'),
      };

      // Cache product nodes for filtering performance
      let productNodes = Array.from(document.querySelectorAll('.js-product-item'));

      // --- Product Search ---
      function normalizeStr(str) {
        return (str || '').toString().trim().toLowerCase();
      }

      function filterProducts(term) {
        const normalizedTerm = normalizeStr(term);
        let visibleCount = 0;

        productNodes.forEach(node => {
          const name = normalizeStr(node.dataset.name);
          const isMatch = name.includes(normalizedTerm);
          
          node.style.display = isMatch ? '' : 'none';
          if (isMatch) visibleCount++;
        });

        // Accessibility Update
        if (els.resultsCount) {
          els.resultsCount.textContent = `${visibleCount} product${visibleCount === 1 ? '' : 's'} visible`;
        }

        // Empty State Toggle
        if (els.emptyStateJs) {
          els.emptyStateJs.style.display = visibleCount === 0 ? '' : 'none';
        }
      }

      // --- Product Interaction (Keyboard) ---
      productNodes.forEach(node => {
        node.addEventListener('keydown', (e) => {
          if (e.key === ' ' || e.key === 'Spacebar') {
            e.preventDefault();
            // Simulate click for keyboard users on the card
            window.location.href = node.href;
          }
        });
      });

      // --- Sorting Logic ---
      function applySorting() {
        const value = els.orderingSelect ? els.orderingSelect.value : '';
        if (!value) {
          window.location.href = '/';
          return;
        }
        window.location.href = '/?sorting_system=' + encodeURIComponent(value);
      }

      // --- Event Listeners ---
      
      // Search Input
      if (els.searchInput) {
        els.searchInput.addEventListener('input', (e) => filterProducts(e.target.value));
      }

      // Sort Button
      if (els.sortButton) {
        els.sortButton.addEventListener('click', applySorting);
      }

      // Initial State
      filterProducts((els.searchInput && els.searchInput.value) || '');

      // Dev Debug
      window.__ALDS = { filter: filterProducts, count: productNodes.length };
    })();
  </script>
</body>
</html>