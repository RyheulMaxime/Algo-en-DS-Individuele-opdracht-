<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AL&DS Shop â€” Customer Profile</title>
  <meta name="description" content="Manage your account and view order history." />
  
  <link rel="icon" sizes="16x16" href="../static/favicon/favicon-16x16.png">
  <link rel="icon" sizes="32x32" href="../static/favicon/favicon-32x32.png">

  <link rel="stylesheet" href="../static/style.css">
</head>

<body>
  {% include 'header.html' %}

  <main class="profile-layout" role="main">
    {% if customer %}
      <h1>Welcome back, {{ customer.customername }}</h1>

      <section class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
          <h2 style="margin:0; font-size:1.5rem;">Account Details</h2>
        </div>
        
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Full Name</span>
            <span class="info-value">{{ customer.customername }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Contact</span>
            <span class="info-value">{{ customer.contactname or '' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Address</span>
            <span class="info-value">{{ customer.address or '' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">City/Zip</span>
            <span class="info-value">{{ customer.postalcode or '' }} {{ customer.city or '' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Country</span>
            <span class="info-value">{{ customer.country or '' }}</span>
          </div>
        </div>

        <div class="modal__actions" style="justify-content: flex-start; margin-top: 1.5rem;">
          <button class="btn btn--primary" id="btn-edit-info">Edit Profile</button>
          <button class="btn btn--ghost" id="btn-change-password">Change Password</button>
        </div>
      </section>

      {% if orders %}
        <section class="card" style="margin-top: 2rem;">
          <h2 style="margin-top:0; margin-bottom:1rem; font-size:1.5rem;">Order History</h2>
          
          <div class="orders-list">
            {% for key, value in orders.items() %}
              <div class="order-item" id="order-{{ key }}">
                <div class="order-details">
                  <strong>{{ value.productname }}</strong>
                  <div class="product-card__meta">
                    Qty: {{ value.quantity }} &bull; Price: {{ value.unitprice }}
                  </div>
                  <div class="product-card__meta">
                    Placed on: {{ value.createdat }}
                  </div>
                </div>
                
                <div class="order-actions">
                  <form action="/customer/delete/{{ key }}" method="POST">
                    <button type="submit" class="btn btn--ghost" aria-label="Cancel order for {{ value.productname }}">
                      Cancel Order
                    </button>
                  </form>
                </div>
              </div>
            {% endfor %}
          </div>
        </section>
      {% endif %}

    {% else %}
      <div class="card" style="text-align:center; padding:3rem;">
        <h1>Not logged in</h1>
        <p>Please log in to view your profile.</p>
        <a href="/login" class="btn btn--primary">Go to Login</a>
      </div>
    {% endif %}
  </main>

  <div id="modal-edit-info" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <h2 class="modal__header">Edit Profile</h2>
      <form action="/customer/edit" method="post">
        <div class="form-group">
          <label class="form-label" for="new_name">Name</label>
          <input class="form-input" type="text" id="new_name" name="new_name" required value="{{ customer.customername or '' }}"/>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="new_contact">Contact</label>
          <input class="form-input" type="text" id="new_contact" name="new_contact" value="{{ customer.contactname or '' }}"/>
        </div>

        <div class="form-group">
          <label class="form-label" for="new_address">Address</label>
          <input class="form-input" type="text" id="new_address" name="new_address" value="{{ customer.address or '' }}"/>
        </div>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">
          <div class="form-group">
            <label class="form-label" for="new_postalcode">Postal Code</label>
            <input class="form-input" type="text" id="new_postalcode" name="new_postalcode" value="{{ customer.postalcode or '' }}"/>
          </div>
          <div class="form-group">
            <label class="form-label" for="new_city">City</label>
            <input class="form-input" type="text" id="new_city" name="new_city" value="{{ customer.city or '' }}" />
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="new_country">Country</label>
          <input class="form-input" type="text" id="new_country" name="new_country" value="{{ customer.country or '' }}" />
        </div>

        <div class="modal__actions">
          <button type="button" class="btn btn--ghost" id="cancel-edit-info">Cancel</button>
          <button type="submit" class="btn btn--primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <div id="modal-change-password" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <h2 class="modal__header">Change Password</h2>
      <form action="/customer/reset" method="post">
        <div class="form-group">
          <label class="form-label" for="previous_password">Current Password</label>
          <input class="form-input" type="password" id="previous_password" name="previous_password"/>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="new_password">New Password</label>
          <input class="form-input" type="password" id="new_password" name="new_password" minlength="4" />
        </div>

        <div class="modal__actions">
          <button type="button" class="btn btn--ghost" id="cancel-change-password">Cancel</button>
          <button type="submit" class="btn btn--primary">Update Password</button>
        </div>
      </form>
    </div>
  </div>

  {% include 'modals.html' %}

  <script>
    (function(){
      'use strict';

      // --- Modal Logic ---
      const els = {
        editBtn: document.getElementById('btn-edit-info'),
        passBtn: document.getElementById('btn-change-password'),
        
        editModal: document.getElementById('modal-edit-info'),
        passModal: document.getElementById('modal-change-password'),
        
        editCancel: document.getElementById('cancel-edit-info'),
        passCancel: document.getElementById('cancel-change-password')
      };

      function toggleModal(modal, isOpen) {
        if (!modal) return;
        if (isOpen) {
          modal.classList.add('is-open');
          modal.setAttribute('aria-hidden', 'false');
          const firstInput = modal.querySelector('input, button');
          if (firstInput) firstInput.focus();
        } else {
          modal.classList.remove('is-open');
          modal.setAttribute('aria-hidden', 'true');
        }
      }

      // Triggers
      if (els.editBtn) els.editBtn.addEventListener('click', () => toggleModal(els.editModal, true));
      if (els.passBtn) els.passBtn.addEventListener('click', () => toggleModal(els.passModal, true));
      
      // Close Actions
      if (els.editCancel) els.editCancel.addEventListener('click', () => toggleModal(els.editModal, false));
      if (els.passCancel) els.passCancel.addEventListener('click', () => toggleModal(els.passModal, false));
      if (els.noticeClose) els.noticeClose.addEventListener('click', () => toggleModal(els.noticeModal, false));

      // Global Escape Key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          toggleModal(els.editModal, false);
          toggleModal(els.passModal, false);
          toggleModal(els.noticeModal, false);
        }
      });
    })();
  </script>
</body>
</html>