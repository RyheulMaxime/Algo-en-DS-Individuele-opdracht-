<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AL&DS Shop â€” Supplier Info</title>

    <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
    
    <link rel="icon" sizes="16x16" href="../static/favicon/favicon-16x16.png">
    <link rel="icon" sizes="32x32" href="../static/favicon/favicon-32x32.png">

    <link rel="stylesheet" href="../static/style.css">

    <style>
        /* Grid for the Top Section (Info + Map) */
        .supplier-top-grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 1.7rem;
            align-items: stretch; /* Make them same height */
        }

        /* Mobile Layout: Stack Info then Map */
        @media (max-width: 900px) {
            .supplier-top-grid {
                grid-template-columns: 1fr;
            }
            /* Map stays 2nd (default HTML order) so it appears BELOW info */
        }

        /* Bottom Section: Products */
        .supplier-products {
            margin-top: 2.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--color-border);
        }

        .supplier-products h2 {
            margin-top: 0;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            color: var(--color-text-main);
        }
    </style>
</head>

<body>
    {% include 'header.html' %}

    <main class="profile-layout" role="main"> {% if supplier %}
            
            <div id="supplier-data" aria-hidden="true" style="display:none;"
                 data-id="{{ supplier.supplierid }}"
                 data-name="{{ supplier.suppliername }}"
                 data-lat="{{ supplier.latitude }}"
                 data-lon="{{ supplier.longitude }}">
            </div>

            <div class="supplier-top-grid">
                
                <section class="card">
                    <h1 style="margin-top:0; font-size:1.8rem;">{{ supplier.suppliername }}</h1>
                    
                    <div style="margin-top:1rem;">
                        <p style="margin:0.25rem 0; color:var(--color-text-muted);">
                            <strong style="color:var(--color-text-main);">Contact:</strong> {{ supplier.contactname }}
                        </p>
                        <p style="margin:0.25rem 0; color:var(--color-text-muted);">
                            <strong style="color:var(--color-text-main);">Address:</strong> {{ supplier.address }}
                        </p>
                        <p style="margin:0.25rem 0; color:var(--color-text-muted);">
                            {{ supplier.postalcode }} {{ supplier.city }}, {{ supplier.country }}
                        </p>
                    </div>
                </section>

                <aside class="map-wrapper" aria-label="Map of supplier location">
                    <div id="map"></div>
                </aside>

            </div>

            <section class="supplier-products">
                <h2>Products from {{ supplier.suppliername }}</h2>

                <div class="product-grid"> {% for product in products %}
                    <a class="product-card"
                       href="/product?id={{ product.productid }}&supplierid={{ product.supplierid }}&categoryid={{ product.categoryid }}"
                       data-id="{{ product.productid }}"
                       data-supplier="{{ product.supplierid }}">
                        <p class="product-card__title">{{ product.productname }}</p>
                        <p class="product-card__meta">{{ product.unit }}</p>
                        <p class="product-card__price">${{ '%.2f'|format(product.price) }}</p>
                    </a>
                    {% endfor %}
                </div>
            </section>

        {% else %}
            <div class="card">
                <h2>Supplier not found</h2>
                <p>The supplier you are looking for does not exist.</p>
                <a href="/" class="btn btn--primary" style="margin-top:1rem;">Return Home</a>
            </div>
        {% endif %}
    </main>

    <script>
        (function(){
            'use strict';

            // --- Map Logic ---
            const el = document.getElementById("supplier-data");
            const mapContainer = document.getElementById("map");
            
            if (!el || !mapContainer) return;

            const supplierId   = el.dataset.id;
            const supplierName = el.dataset.name;
            const lat          = Number(el.dataset.lat);
            const lon          = Number(el.dataset.lon);

            const isValidCoords = Number.isFinite(lat) && Number.isFinite(lon);

            if (!isValidCoords) {
                mapContainer.innerHTML = '<div style="padding:1rem; text-align:center; color:#777;">Location data not available.</div>';
                return;
            }

            try {
                const map = new maplibregl.Map({
                    style: 'https://tiles.openfreemap.org/styles/liberty',
                    center: [lon, lat],
                    zoom: 12,
                    container: 'map'
                });

                map.addControl(new maplibregl.NavigationControl({ showCompass: false }), 'top-left');

                // Custom Marker
                const markerEl = document.createElement("div");
                Object.assign(markerEl.style, {
                    width: "24px",
                    height: "24px",
                    borderRadius: "50%",
                    background: "linear-gradient(135deg, var(--color-brand-primary), var(--color-brand-secondary))",
                    boxShadow: "0 4px 12px rgba(0,0,0,0.3)",
                    border: "3px solid #fff",
                    cursor: "pointer"
                });

                // Popup
                const popupContent = document.createElement("div");
                const title = document.createElement("strong");
                title.textContent = supplierName;
                popupContent.appendChild(title);

                const popup = new maplibregl.Popup({ offset: 16, closeButton: false })
                    .setDOMContent(popupContent);

                new maplibregl.Marker({ element: markerEl })
                    .setLngLat([lon, lat])
                    .setPopup(popup)
                    .addTo(map);

                markerEl.addEventListener('mouseenter', () => popup.addTo(map));
                markerEl.addEventListener('mouseleave', () => popup.remove());

            } catch (error) {
                console.error("Map initialization failed:", error);
                mapContainer.innerHTML = '<div style="padding:1rem; text-align:center;">Unable to load map.</div>';
            }

        })();
    </script>

</body>
</html>