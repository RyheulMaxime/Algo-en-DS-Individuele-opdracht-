<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="AL&DS Shop — premium, responsive product listing" />
  <title>AL&DS Shop — Home</title>

  <link rel="icon" sizes="16x16" href="../static/favicon/favicon-16x16.png">
  <link rel="icon" sizes="32x32" href="../static/favicon/favicon-32x32.png">

  <link rel="stylesheet" href="../static/style.css">
</head>
<body>

  <header class="site-header" role="banner">
    <a class="site-header__brand" href="/" aria-label="Go to homepage">AL&amp;DS Shop</a>
    <p class="site-header__tagline">Curated products — clean design, delightful shopping</p>

    <div class="user-menu" aria-hidden="false">
      <div id="user-dropdown" class="user-menu__dropdown" aria-haspopup="true">
        {% if customer %}
          <button id="btn-user-menu" class="user-menu__trigger" aria-expanded="false">
            {{ customer.customername }}
          </button>
          <div class="user-menu__content" role="menu" aria-label="User menu">
            <a role="menuitem" class="user-menu__link" href="/customer">Customer Profile</a>
            <a role="menuitem" class="user-menu__link" href="/logout">Logout</a>
          </div>
        {% else %}
          <button id="btn-user-menu" class="user-menu__trigger" aria-expanded="false">
            Account
          </button>
          <div class="user-menu__content" role="menu" aria-label="Account menu">
            <a role="menuitem" class="user-menu__link" href="/login">Login</a>
            <a role="menuitem" class="user-menu__link" href="/register">Register</a>
          </div>
        {% endif %}
      </div>
    </div>
  </header>

  <section class="toolbar" aria-label="Search and sort products">
    <form id="search-form" role="search" onsubmit="return false;" aria-label="Search products">
      <label for="search-input" class="sr-only">Search products</label>
      <input id="search-input" class="input-control" type="search" placeholder="Search products…" aria-label="Search products" autocomplete="off" />
    </form>

    <div class="toolbar__field" aria-hidden="false">
      <label for="ordering-select" class="sr-only">Sort products by</label>
      <select id="ordering-select" class="select-control" aria-label="Sort products">
        <option value="" selected disabled hidden>Select Sorting system</option>
        <option value="category">Category</option>
        <option value="price_asc">Price: Low → High</option>
        <option value="price_desc">Price: High → Low</option>
        <option value="name_asc">Name: A → Z</option>
        <option value="name_desc">Name: Z → A</option>
      </select>
    </div>

    <div>
      <button id="btn-sort" class="btn-sort" aria-label="Apply sorting">Sort</button>
    </div>
  </section>

  <div aria-live="polite" aria-atomic="true" id="results-count" class="sr-only"></div>

  <main id="main-content" role="main">
    <section id="products-grid" class="product-grid" aria-label="Products">
      {% if sorting_system == "category" %}
        {% for key, value in products.items() %}
          <h2 class="product-grid__category-title">{{ key }}</h2>
          {% for product in value %}
            <a class="product-card js-product-item"
               href="/product?id={{ product.productid }}&supplierid={{ product.supplierid }}&categoryid={{ product.categoryid }}"
               data-id="{{ product.productid }}"
               data-supplier="{{ product.supplierid }}"
               data-category="{{ product.categoryid }}"
               data-name="{{ product.productname|default('') }}"
               data-price="{{ product.price|default(0) }}">
              <p class="product-card__title">{{ product.productname }}</p>
              <p class="product-card__meta">{{ product.unit }}</p>
              <p class="product-card__price">${{ '%.2f'|format(product.price) }}</p>
            </a>
          {% endfor %}
        {% endfor %}
      {% elif products %}
        {% for product in products %}
          <a class="product-card js-product-item"
             href="/product?id={{ product.productid }}&supplierid={{ product.supplierid }}&categoryid={{ product.categoryid }}"
             data-id="{{ product.productid }}"
             data-supplier="{{ product.supplierid }}"
             data-category="{{ product.categoryid }}"
             data-name="{{ product.productname|default('') }}"
             data-price="{{ product.price|default(0) }}">
            <p class="product-card__title">{{ product.productname }}</p>
            <p class="product-card__meta">{{ product.unit }}</p>
            <p class="product-card__price">${{ '%.2f'|format(product.price) }}</p>
          </a>
        {% endfor %}
      {% else %}
        <div class="empty-state">No products available.</div>
      {% endif %}
    </section>

    <div id="empty-state-js" class="empty-state" style="display:none">No products found.</div>
  </main>

  <div id="modal-login" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="login-title">
      <h2 id="login-title" class="modal__title">Login to your account</h2>
      <form id="form-login" class="js-login-form" autocomplete="on">
        <label for="username" class="sr-only">Username</label>
        <input id="username" class="input-control" name="username" type="text" placeholder="Username" required autocomplete="username" style="margin-top:0.5rem" />
        
        <label for="password" class="sr-only">Password</label>
        <input id="password" class="input-control" name="password" type="password" placeholder="Password" autocomplete="current-password" style="margin-top:0.5rem" />
        
        <div class="modal__actions">
          <button type="button" class="btn btn--ghost" id="btn-login-cancel">Cancel</button>
          <button type="submit" class="btn btn--primary">Login</button>
        </div>
      </form>
    </div>
  </div>

  <div id="modal-error" class="overlay" role="alertdialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="error-title">
      <h2 id="error-title" class="modal__title">Login failed</h2>
      <p id="error-message" class="modal__text">Unable to log in. Please check your credentials and try again.</p>
      <div class="modal__actions">
        <button class="btn btn--ghost" id="btn-error-close">Close</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  
  <script>
    (function () {
      'use strict';

      // --- DOM Elements ---
      const els = {
        searchInput: document.getElementById('search-input'),
        orderingSelect: document.getElementById('ordering-select'),
        sortButton: document.getElementById('btn-sort'),
        resultsCount: document.getElementById('results-count'),
        emptyStateJs: document.getElementById('empty-state-js'),
        userDropdown: document.getElementById('user-dropdown'),
        userButton: document.getElementById('btn-user-menu'),
        
        // Modals
        loginOverlay: document.getElementById('modal-login'),
        errorOverlay: document.getElementById('modal-error'),
        loginForm: document.getElementById('form-login'),
        loginCancel: document.getElementById('btn-login-cancel'),
        errorClose: document.getElementById('btn-error-close'),
        
        // Triggers (Buttons that might not exist based on auth state)
        openLoginBtn: document.getElementById('open-login'),
      };

      // Cache product nodes for filtering performance
      let productNodes = Array.from(document.querySelectorAll('.js-product-item'));

      // --- Dropdown Logic ---
      if (els.userButton && els.userDropdown) {
        els.userButton.addEventListener('click', (e) => {
          e.stopPropagation();
          const isExpanded = els.userButton.getAttribute('aria-expanded') === 'true';
          toggleDropdown(!isExpanded);
        });

        document.addEventListener('click', (e) => {
          if (!els.userDropdown.contains(e.target)) {
            toggleDropdown(false);
          }
        });
      }

      function toggleDropdown(shouldOpen) {
        if (!els.userDropdown || !els.userButton) return;
        
        if (shouldOpen) {
          els.userDropdown.classList.add('is-open');
          els.userButton.setAttribute('aria-expanded', 'true');
        } else {
          els.userDropdown.classList.remove('is-open');
          els.userButton.setAttribute('aria-expanded', 'false');
        }
      }

      // --- Product Search ---
      function normalizeStr(str) {
        return (str || '').toString().trim().toLowerCase();
      }

      function filterProducts(term) {
        const normalizedTerm = normalizeStr(term);
        let visibleCount = 0;

        productNodes.forEach(node => {
          const name = normalizeStr(node.dataset.name);
          const isMatch = name.includes(normalizedTerm);
          
          node.style.display = isMatch ? '' : 'none';
          if (isMatch) visibleCount++;
        });

        // Accessibility Update
        if (els.resultsCount) {
          els.resultsCount.textContent = `${visibleCount} product${visibleCount === 1 ? '' : 's'} visible`;
        }

        // Empty State Toggle
        if (els.emptyStateJs) {
          els.emptyStateJs.style.display = visibleCount === 0 ? '' : 'none';
        }
      }

      // --- Product Interaction (Keyboard) ---
      productNodes.forEach(node => {
        node.addEventListener('keydown', (e) => {
          if (e.key === ' ' || e.key === 'Spacebar') {
            e.preventDefault();
            // Simulate click for keyboard users on the card
            window.location.href = node.href;
          }
        });
      });

      // --- Sorting Logic ---
      function applySorting() {
        const value = els.orderingSelect ? els.orderingSelect.value : '';
        if (!value) {
          window.location.href = '/';
          return;
        }
        window.location.href = '/?sorting_system=' + encodeURIComponent(value);
      }

      // --- Modal Management ---
      function setOverlayState(overlay, isOpen) {
        if (!overlay) return;
        
        if (isOpen) {
          overlay.classList.add('is-open');
          overlay.setAttribute('aria-hidden', 'false');
          // Focus trap helper: focus first interactive element
          const firstInput = overlay.querySelector('input, button');
          if (firstInput) firstInput.focus();
        } else {
          overlay.classList.remove('is-open');
          overlay.setAttribute('aria-hidden', 'true');
        }
      }

      // --- Event Listeners ---
      
      // Search Input
      if (els.searchInput) {
        els.searchInput.addEventListener('input', (e) => filterProducts(e.target.value));
      }

      // Sort Button
      if (els.sortButton) {
        els.sortButton.addEventListener('click', applySorting);
      }

      // Modal Triggers
      if (els.openLoginBtn) {
        els.openLoginBtn.addEventListener('click', (e) => {
          e.preventDefault();
          setOverlayState(els.loginOverlay, true);
        });
      }

      if (els.loginCancel) {
        els.loginCancel.addEventListener('click', () => setOverlayState(els.loginOverlay, false));
      }

      if (els.errorClose) {
        els.errorClose.addEventListener('click', () => setOverlayState(els.errorOverlay, false));
      }

      // Global Keyboard Shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          setOverlayState(els.loginOverlay, false);
          setOverlayState(els.errorOverlay, false);
        }
      });

      // --- Socket.IO & Login Logic (WIP) ---
      let socket = null;
      try {
        socket = io();
      } catch (err) {
        console.warn('Socket.IO init failed:', err);
      }

      /* * TODO: Socket-based login logic.
       * Currently disabled per requirements "For later does not seem to work with socket".
       * * Implementation plan:
       * 1. Listen to 'submit' on els.loginForm
       * 2. Emit 'login' event
       * 3. Handle 'login_failed' and 'login_success' socket events
       */

      // Initial State
      filterProducts((els.searchInput && els.searchInput.value) || '');

      // Dev Debug
      window.__ALDS = { filter: filterProducts, count: productNodes.length };
    })();
  </script>
</body>
</html>